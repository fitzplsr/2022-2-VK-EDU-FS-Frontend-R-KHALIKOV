<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Messenger</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="style.css" rel="stylesheet"></head>
    <body>
        <div class="screen">
            <div class="top-box">
                <div class="status-bar">
                    <i class="material-icons"  id="connection_icon">signal_cellular_alt</i>&nbsp;
                    <i class="material-icons" id="wifi_icon">wifi</i>&nbsp;
                    <i class="material-icons" id="battery_icon">battery_3_bar</i>
                </div>
                <div class="user-line">
                    <i class="material-icons" id="arrow_icon">arrow_back</i>
                    <i class="material-icons" id="account_icon">account_circle</i>
                    <div class="user">
                        <div class="username">Boss</div>
                        <div class="status">online</div>
                    </div>
                    <i class="material-icons" id="search_icon">search</i>
                    <i class="material-icons" id="menu_icon">more_vert</i>
                </div>
            </div>
            <div class="chat">
                <div id="start"></div>
            </div>
            <div class="input-box">
                <form class="form" action="/">
                    <input class="form-input" name="message-text" placeholder="Cообщение" type="text" autocomplete="off" >
                    <i class="material-icons" id="attachment_icon">attachment</i>
                </form>
            </div>
        </div>
        <script>
            const form = document.querySelector('form');
            const input = document.querySelector('.form-input');
            const message = document.querySelector('.message');

            let chatInfo = localStorage.getItem("chat");
            
            if (chatInfo){ 
                const dicts = JSON.parse(chatInfo);
                for(const dict in dicts) {
                    post(dicts[dict])
                }
            }
            else {
                const dict = {"message0":{"name":"companion", "text":"Hi, men", "time":"21:54"}}
                post(dict["message0"]);
                localStorage.setItem("chat", JSON.stringify(dict));
                localStorage.setItem("counter", "0");
            }

            form.addEventListener('submit', this.handleSubmit.bind(this));
            form.addEventListener('keypress', this.handleKeyPress.bind(this));

            function post(info){
                let chat_window = document.createElement('div')
                if (info["name"] == "companion") {
                    id = "1"
                } else if (info["name"] == "Me") {
                    id = "2"
                }
                chat_window.setAttribute('class', 'messageFromUser'+ id);
                const user_text = document.createElement('div');
                user_text.setAttribute('class', 'text');
                user_text.textContent = info["text"];
                const user_time = document.createElement('div');
                user_time.setAttribute('class', 'time')
                user_time.textContent = info["time"]
                chat_window.appendChild(user_time);
                chat_window.appendChild(user_text);
                var sp2 = document.getElementById('start');
                var link2 = sp2.parentNode;
                link2.insertBefore(chat_window, sp2);
                chat_window.scrollIntoView();
            }

            function handleSubmit(event) {
                event.preventDefault();
                const inputMessage = input.value;
                if (!inputMessage) return ;
                input.value = '';
                let messageInfo = {};
                let counter = String(Number(localStorage.getItem("counter"))+1);
                const now = new Date();
                messageInfo["name"] = "Me";
                messageInfo["text"] = inputMessage;
                messageInfo["time"] = now.toLocaleTimeString("ru-Ru").substring(0,5);
                let dict = JSON.parse(localStorage.getItem("chat"))
                dict['message'+counter] = messageInfo
                dictJSON = JSON.stringify(dict)
                localStorage.setItem("chat", dictJSON);
                localStorage.setItem("counter", counter);
                post(messageInfo);
            }

            function handleKeyPress (event) {
                if (event.keyCode === 13) {
                    form.dispatchEvent(new Event('submit'));
                }
            }
        </script>
    <script type="text/javascript" src="bundle.js"></script></body>
</html> 

 